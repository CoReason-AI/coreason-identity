# **AGENTS.md**

**Note to Agent:** This file contains the **Supreme Law** for this repository. It defines the architectural constraints of the "Identity Bouncer." Read this before planning or executing *any* task.

# **PRIMARY DIRECTIVE: THE SECURITY MIDDLEWARE PROTOCOL**

**Current Status:** Active Authentication Middleware & CLI
**Role:** The "Bouncer" â€” Verify identities, enforce access lists, but NEVER issue credentials.

## **1. The "Bouncer" Directives**

You are tasked with maintaining the security perimeter. Adhere to the following architectural laws without exception:

### **Law 1: The "Zero-Copy" Security Rule (PII Containment)**

* **Constraint:** Sensitive data (raw claims, PII) MUST NEVER leak into logs or string representations.
* **Forbidden:**
* Logging raw `UserContext` objects without redaction.
* Printing complete tokens or claims dictionaries to stdout/stderr.
* Implementing `__repr__` methods that simply dump `self.__dict__`.


* **Mandatory:** `UserContext` and similar models must override `__repr__` to mask sensitive fields (e.g., `claims='<REDACTED>'`).

### **Law 2: Container-Native Observability (The "No-Disk" Rule)**

* **Constraint:** This application runs in ephemeral containers. Log files are a liability (Disk Exhaustion).
* **Forbidden:**
* Creating local log files (e.g., `logger.add("app.log")`).
* Creating `logs/` directories.
* Rotating files locally.


* **Allowed:**
* Logging to `sys.stderr` (Human-readable).
* Logging to `sys.stdout` (JSON structured, if env var `COREASON_LOG_JSON=true`).



### **Law 3: "Borrow Over Build" (The Crypto Rule)**

* **Constraint:** Do NOT invent cryptography or protocol logic.
* **Forbidden:**
* Writing custom JWT parsers.
* Implementing OIDC discovery logic manually.
* Parsing `Authorization` headers with raw string splitting (unless wrapping a library).


* **Mandatory:** Use **Authlib** for all OIDC/OAuth2 interactions. Use **Pydantic** for all data validation.

---

## **2. Development Protocol**

**You MUST follow this iterative process for every task:**

1. **Security Impact Analysis:** Before writing code, ask: *"Could this change allow a 'Confused Deputy' attack or leak PII?"*
2. **Atomic Implementation:** Break tasks into the smallest testable units.
3. **Strict Typing:** Mypy `strict = true` is enforced. No `Any` allowed in public interfaces.
4. **Test Coverage:** Maintain 100% coverage. Tests must verify *security failures* (e.g., "What happens if the token is expired?"), not just happy paths.

---

## **3. Technical Standards**

### **Environment & Package Management**

* **Manager:** Poetry.
* **Language:** Python 3.12+.
* **License:** Prosperity Public License 3.0. Every file must include the license header.

### **Code Style & Typing**

* **Linting:** `ruff check --fix` (Strict).
* **Formatting:** `ruff format`.
* **Typing:** Strict `mypy`.

### **Logging (Active Pattern)**

* **Library Responsibility:** Configure logging based on environment variables (`COREASON_LOG_LEVEL`, `COREASON_LOG_JSON`).
* **Pattern:**
```python
# src/coreason_identity/utils/logger.py
# This module IS allowed to configure sinks because it manages the application's observability contract.
logger.configure(handlers=[{"sink": sys.stdout, "serialize": True}])

```



## **4. File Structure Constraints**

* **`src/coreason_identity/`**:
* **`main.py`**: The CLI entry point (Allowed here, unlike the manifest repo).
* **`manager.py`**: The high-level orchestrator.
* **`device_flow_client.py`**: Logic for RFC 8628.
* **`models.py`**: Pydantic models with strict PII redaction.


* **Root**:
* **Allowed:** `Dockerfile` (Used for demos or specific CLI builds).
* **Allowed:** `docker-compose.yml` (For local dev/testing mocks).



## **5. Testing Guidelines**

* **Mock The World:** Unit tests MUST NOT make real network calls to Auth0/Keycloak.
* Use `respx` or `unittest.mock` to simulate OIDC discovery and JWKS endpoints.


* **Crypto-Valid Tests:** When testing validation, use real signed JWTs (generated by a test keypair), not just random strings, to prove `Authlib` integration works.
* **PII Regression Tests:** Specific tests must exist to PROVE that `str(user_context)` does not contain the raw claims dictionary.

## **6. Human-in-the-Loop Triggers**

**STOP and ASK the user if:**

* You need to change the hashing algorithm for PII obfuscation.
* You encounter a scenario where "Bypass Mode" (ignoring signatures) seems necessary for development.
* You are tempted to add a "God Mode" or "Admin Override" that bypasses the Bouncer logic.
* You need to add a dependency that is not `authlib`, `httpx`, `pydantic`, or `loguru`.
